var fs = require('fs')
var express = module.exports = require('express')
var path = require('path')
var router = require('./router')
var redis = require('redis')
var Db = require('mongodb').Db
var Connection = require('mongodb').Connection
var Server = require('mongodb').Server
var mongo = require('mongodb')

module.exports.createApp = function(baseDir, config) {
	config = config || {};

	var appDir = baseDir + "/app",
	app = express.createServer();

	app.configure(function() {
		app.set('base_dir', appDir);
		app.set('public', app + '/public');
		app.set('views', baseDir + '/app/views');
		app.set('view engine', 'jade');

		app.use(express.bodyParser());
		app.use(express.methodOverride());
		app.use(express.static(baseDir + '/app/public'));
	})

	app.redisClient = redis.createClient((config.redisPort || 6379), (config.redisHost || 'localhost'));

	app.setResult = function(result) {
		this.db = new Db("testProject", new Server("127.0.0.1", 27017, {}), {native_parser:true})
		this.db.open(function(err, db) {
			db.collection("test", function(err, collection) {
				collection.update({taskId:result.taskId}, {$set:{result:result.result}}, {safe:true}, function(err) {})
			})
		})
	}

	app.getTask = function(callback) {
		this.db = new Db("testProject", new Server("127.0.0.1", 27017, {}), {native_parser:true})

		this.db.open(function(err, db) {
			db.collection("test", function(err, collection) {
				collection.count(function(err, count) {
					console.log("There are " + count + " records.");
					collection.find({state:'wait'}, {limit:1}, function(err, cursor) {
						cursor.toArray(function(err, docs) {
							console.log("----------")
							console.log(docs[0])
							var doc = docs[0]
							if (doc != null) {
								var task = {};
								if (err) {
									console.log('err: ' + err);
								} else {
									task.taskId = doc.taskId
									task.func = doc.func
									task.args = doc.args
								}
								callback(task);
							}
							console.log("----------")
						})
					})
				})
			})
		})
	}
	return app;
}

module.exports.getPageContents = function(baseDir, page) {
	var fs = require('fs');
	var filePath = baseDir + '/app/views/' + page + '.jade';
	var data = fs.readFileSync(filePath, 'utf8');
	var jade = require('jade');
	var func = jade.compile(data);
	console.log('file data: ' + data);

	return { contents: func() };
}

module.exports.listen = function(app) {
	return require('socket.io').listen(app);
}

function showProperties(obj) {
	var s = "";
	for (var i in obj) {
		s += i + ","
	}
	s = s.substring(0, s.length - 1);
	console.log(s);
}
