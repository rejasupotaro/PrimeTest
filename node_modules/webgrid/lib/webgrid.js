var fs = require('fs')
var env = process.env.NODE_ENV || "development"
var express = module.exports = require('express')
var path = require('path')
var router = require('./router')
var redis = require('redis')

module.exports.createApp = function(baseDir) {
	var app = express.createServer()
  app.appDir = baseDir + "/app"

	app.configure(function() {
		app.set('base_dir', app.appDir);
		app.set('public', app + '/public');
		app.set('views', baseDir + '/app/views');
		app.set('view engine', 'jade');

		app.use(express.bodyParser());
		app.use(express.methodOverride());
		app.use(express.static(baseDir + '/app/public'));
	})

  var TaskManager = require("./taskManager")
  var taskManager = new TaskManager()
	app.getTask = taskManager.getTask
	app.setResult = taskManager.setResult

  return app;
}

module.exports.compileView = function(baseDir, page) {
	var fs = require('fs')
	var filePath = baseDir + '/app/views/' + page + '.jade'
	var data = fs.readFileSync(filePath, 'utf8')
	var jade = require('jade')
	var func = jade.compile(data)

	return { contents: func() }
}

module.exports.listen = function(app) {
  require(app.appDir + '/task/main')
  var config = require(app.appDir + "/config/" + env)
  var port = config.port || 3000
  app.listen(port)
  console.log("webgrid server running on port: " + port)
	return require('socket.io').listen(app)
}

