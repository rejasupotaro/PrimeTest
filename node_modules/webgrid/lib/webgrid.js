var fs = require('fs')
var express = module.exports = require('express')
var path = require('path')
var router = require('./router')
var redis = require('redis')
var Db = require('mongodb').Db
var Connection = require('mongodb').Connection
var Server = require('mongodb').Server
var mongo = require('mongodb')

module.exports.createApp = function(baseDir, config) {
	config = config || {};

	var appDir = baseDir + "/app",
	app = express.createServer();

	app.configure(function() {
		app.set('base_dir', appDir);
		app.set('public', app + '/public');
		app.set('views', baseDir + '/app/views');
		app.set('view engine', 'jade');

		app.use(express.bodyParser());
		app.use(express.methodOverride());
		app.use(express.static(baseDir + '/app/public'));
	})

	app.redisClient = redis.createClient((config.redisPort || 6379), (config.redisHost || 'localhost'));

	var TaskManager = require('./taskManager')
	var taskManager = new TaskManager()

	app.setResult = function(result) {
		taskManager.setResult(result)
	}

	app.getTask = function(callback) {
		taskManager.getTask(callback)
	}
	return app;
}

module.exports.getPageContents = function(baseDir, page) {
	var fs = require('fs');
	var filePath = baseDir + '/app/views/' + page + '.jade';
	var data = fs.readFileSync(filePath, 'utf8');
	var jade = require('jade');
	var func = jade.compile(data);
	console.log('file data: ' + data);

	return { contents: func() };
}

module.exports.listen = function(app) {
	return require('socket.io').listen(app);
}

function showProperties(obj) {
	var s = "";
	for (var i in obj) {
		s += i + ","
	}
	s = s.substring(0, s.length - 1);
	console.log(s);
}
